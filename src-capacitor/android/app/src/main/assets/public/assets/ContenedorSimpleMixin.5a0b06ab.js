var E=Object.defineProperty;var A=(l,e,i)=>e in l?E(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i;var o=(l,e,i)=>(A(l,typeof e!="symbol"?e+"":e,i),i);import{q as L,S as y,i as d,n as h,r as b}from"./utils.30e08aa2.js";import{U as p,f,e as c,bA as v,g as w,bi as k,u as x,a1 as C}from"./index.976e8f3c.js";class V{constructor(e,i,t,s){o(this,"refs");o(this,"entidad");o(this,"entidad_vacia");o(this,"entidad_copia");o(this,"notificaciones",p());o(this,"argsDefault");o(this,"controller");o(this,"controllerFiles");o(this,"validaciones",[]);this.controller=i,this.controllerFiles=s,this.refs=t,this.entidad=f(new e),this.entidad_vacia=f(new e),this.entidad_copia=f(new e)}async ejecutarValidaciones(){try{for(const e of this.validaciones)if(!await e.validar())return}catch(e){return e instanceof Error&&this.notificaciones.notificarAdvertencia(e.message),!1}return!0}agregarValidaciones(...e){this.validaciones.push(...e)}limpiarValidaciones(){this.validaciones.splice(1,this.validaciones.length-1)}indexElementoEnLista(e){return this.refs.listado.value.findIndex(i=>i.id===e)}indexElementoEnListaArchivos(e){return this.refs.listadoArchivos.value.findIndex(i=>i.id===e)}agregarElementoListadoActual(e,i=!0){i?this.refs.listado.value=[e,...this.refs.listado.value]:this.refs.listado.value=[...this.refs.listado.value,e]}agregarElementosListadoActual(e,i=!0){i?this.refs.listado.value=[...e,...this.refs.listado.value]:this.refs.listado.value=[...this.refs.listado.value,...e]}agregarElementoListadoArchivosActual(e){this.refs.listadoArchivos.value=[e,...this.refs.listadoArchivos.value]}eliminarElementoListaActual(e){const i=this.indexElementoEnLista(e.id);i>=0&&(this.refs.listado.value.splice(i,1),this.refs.listado.value=[...this.refs.listado.value])}eliminarElementoListaArchivosActual(e){const i=this.indexElementoEnListaArchivos(e.id);i>=0&&(this.refs.listadoArchivos.value.splice(i,1),this.refs.listado.value=[...this.refs.listado.value])}actualizarElementoListadoActual(e){const i=this.indexElementoEnLista(e.id);i>=0&&(this.refs.listado.value.splice(i,1,e),this.refs.listado.value=[...this.refs.listado.value])}async obtenerListados(e){const i=[],t={};let s=0,a,r;for(const u in e){t[s++]=u;const n=e[u];n.controller&&n.params?(a=n.controller,r=n.params):Array.isArray(n)?(a=null,r={}):(a=e[u],r={}),a?i.push(a.listar({...this.argsDefault,...r})):i.push(new Promise(g=>g(n))),this.refs.listadosAuxiliares[u]=[]}return Promise.allSettled(i).then(u=>{u.forEach((n,g)=>{if(n.status==="fulfilled"){const m=t[g];Array.isArray(n.value)&&this.refs.listadosAuxiliares[m].push(...n.value),Array.isArray(n.value.result)&&this.refs.listadosAuxiliares[m].push(...n.value.result)}})})}seCambioEntidad(e){return L(e,this.entidad)}getController(){return this.controller}}class j{bindHook(e,i){this[e]=i}}class B extends j{constructor(){super();o(this,"onBeforeGuardar");o(this,"onGuardado");o(this,"onBeforeModificar");o(this,"onModificado");o(this,"onBeforeConsultar");o(this,"onConsultado");o(this,"onReestablecer");o(this,"onListado");o(this,"onListadosCargados");this.onBeforeGuardar=()=>{},this.onGuardado=()=>{},this.onBeforeModificar=()=>{},this.onModificado=()=>{},this.onBeforeConsultar=()=>{},this.onConsultado=()=>{},this.onReestablecer=()=>{},this.onListado=()=>{},this.onListadosCargados=()=>{}}}class P extends B{constructor(){super()}}class H{constructor(){o(this,"tabs");o(this,"tabsPage");o(this,"validador");o(this,"filtros");o(this,"listadoActividades");o(this,"listadoArchivos");o(this,"listado");o(this,"currentPageListado");o(this,"nextPageUrl");o(this,"accion");o(this,"disabled");o(this,"listadosAuxiliares");o(this,"errors");o(this,"metaPagination");o(this,"pagination",c({sortBy:"desc",descending:!1,page:1,rowsPerPage:3,rowsNumber:10,last_page:2,total:0}));this.errors=c(),this.tabs=c(),this.tabsPage=c("1"),this.validador=c(),this.listadosAuxiliares=f({}),this.filtros=f({search:null,fields:null}),this.listado=c([]),this.listadoArchivos=c([]),this.listadoActividades=c([]),this.currentPageListado=c(1),this.nextPageUrl=c(),this.accion=c(v.nuevo),this.metaPagination=c(),this.disabled=w(()=>[v.eliminar,v.consultar].includes(this.accion.value))}}class _ extends V{constructor(i,t,s){super(i,t,k(new H),s);o(this,"hooks",new P);o(this,"statusEssentialLoading",new y)}async cargarVista(i){try{this.statusEssentialLoading.activar(),await i()}catch(t){throw t}finally{this.statusEssentialLoading.desactivar()}}useReferencias(){return{entidad:this.entidad,...this.refs}}useComportamiento(){return{listar:this.listar.bind(this),listarArchivos:this.listarArchivos.bind(this),listarActividades:this.listarActividades.bind(this),filtrar:this.filtrar.bind(this),consultar:this.consultar.bind(this),guardarArchivos:this.guardarArchivos.bind(this),guardarActividades:this.guardarActividades.bind(this),guardarListado:this.guardarListado.bind(this),guardar:this.guardar.bind(this),editar:this.editar.bind(this),editarParcial:this.editarParcial.bind(this),eliminar:this.eliminar.bind(this),eliminarArchivo:this.eliminarArchivo.bind(this),eliminarListado:this.eliminarListado.bind(this),reestablecer:this.reestablecer.bind(this),obtenerListados:this.obtenerListados.bind(this),cargarVista:this.cargarVista.bind(this),setValidador:this.setValidador.bind(this)}}useHooks(){return{onBeforeGuardar:i=>this.hooks.bindHook("onBeforeGuardar",i),onGuardado:i=>this.hooks.bindHook("onGuardado",i),onBeforeConsultar:i=>this.hooks.bindHook("onBeforeConsultar",i),onConsultado:i=>this.hooks.bindHook("onConsultado",i),onBeforeModificar:i=>this.hooks.bindHook("onBeforeModificar",i),onModificado:i=>this.hooks.bindHook("onModificado",i),onReestablecer:i=>this.hooks.bindHook("onReestablecer",i),onListado:i=>this.hooks.bindHook("onListado",i),onListadosCargados:i=>this.hooks.bindHook("onListadosCargados",i)}}async consultar(i,t){if(this.hooks.onBeforeConsultar(),i.id===null)return this.notificaciones.notificarAdvertencia("No se puede consultar el recurso con id null");const s=i.id;try{this.cargarVista(async()=>{const{result:a}=await this.controller.consultar(s,{...this.argsDefault,...t});await this.entidad.hydrate(a),await this.entidad_copia.hydrate(JSON.parse(JSON.stringify(this.entidad))),this.refs.tabs.value="formulario",this.hooks.onConsultado(a)})}catch(a){if(d(a)){const r=a.erroresValidacion;await h(r,this.notificaciones)}}finally{}}async listar(i,t=!1){this.statusEssentialLoading.activar();try{const{result:s,meta:a,response:r}=await this.controller.listar(i);if(i!=null&&i.hasOwnProperty("export"))return b(r.data,i.titulo,i.export);s.length==0&&this.notificaciones.notificarInformacion("A\xFAn no se han agregado elementos."),t?this.refs.listado.value.push(...s):this.refs.listado.value=s,this.refs.pagination.value.last_page=a==null?void 0:a.last_page,this.refs.pagination.value.page=a==null?void 0:a.current_page,this.refs.pagination.value.total=a==null?void 0:a.total}catch(s){if(console.error(s),d(s)){const a=s.erroresValidacion;await h(a,this.notificaciones)}else this.notificaciones.notificarError(s+"")}finally{this.statusEssentialLoading.desactivar()}this.hooks.onListado()}async filtrar(i){this.cargarVista(async()=>{try{const{result:t}=await this.controller.filtrar(i);t.length==0&&this.notificaciones.notificarInformacion("No se encontraron coincidencias."),this.refs.listado.value=t,this.notificaciones.notificarInformacion("Resultados encontrados.")}catch(t){this.notificaciones.notificarError(t)}})}async reestablecer(){var i;this.entidad.hydrate(this.entidad_vacia),this.refs.accion.value=v.nuevo,(i=this.refs.validador.value)==null||i.$reset(),this.hooks.onReestablecer()}async guardar(i,t=!0,s){if(console.log("guardar"),this.statusEssentialLoading.activar(),!this.seCambioEntidad(this.entidad_vacia))throw this.notificaciones.notificarAdvertencia("No se ha efectuado ningun cambio"),this.statusEssentialLoading.desactivar(),new Error("No se ha efectuado ningun cambio");if(console.log(this.refs.validador.value),this.refs.validador.value&&!await this.refs.validador.value.$validate()||!await this.ejecutarValidaciones())throw this.notificaciones.notificarAdvertencia("Verifique el formulario"),this.statusEssentialLoading.desactivar(),new Error("Verifique el formulario");this.hooks.onBeforeGuardar();try{const{response:a}=await this.controller.guardar(i,{...s,...this.argsDefault});this.notificaciones.notificarCorrecto(a.data.mensaje),a.data.modelo&&(Array.isArray(a.data.modelo)?this.agregarElementosListadoActual(a.data.modelo,t):(this.agregarElementoListadoActual(a.data.modelo,t),this.entidad.hydrate(a.data.modelo)));const r=JSON.parse(JSON.stringify(this.entidad));return this.hooks.onGuardado(r.id,a.data),this.reestablecer(),r}catch(a){if(d(a)){const r=a.erroresValidacion;await h(r,this.notificaciones)}throw a}finally{this.statusEssentialLoading.desactivar()}}async eliminarArchivo(i,t){this.notificaciones.confirmar("\xBFEst\xE1 seguro que desea eliminar?",()=>{if(i.id===null)return this.notificaciones.notificarAdvertencia("No se puede eliminar el recurso con id null");if(!this.controllerFiles)return this.notificaciones.notificarError("El mixin requiere de una instancia de ArchivoController()");this.controllerFiles.eliminarFile(i.id).then(({response:s})=>{this.notificaciones.notificarCorrecto(s.data.mensaje),this.eliminarElementoListaArchivosActual(i),t&&t()}).catch(s=>{if(d(s)){const a=s.erroresValidacion;h(a,this.notificaciones)}else this.notificaciones.notificarError(s.mensaje)})})}async eliminarListado(i){this.controller.eliminarListado(i).then(({response:t})=>{t.data.results&&(this.refs.listado.value=t.data.results),this.notificaciones.notificarCorrecto(t.data.mensaje)}).catch(t=>{if(d(t)){const s=t.erroresValidacion;h(s,this.notificaciones)}else this.notificaciones.notificarError(t.mensaje)})}async listarArchivos(i,t){this.statusEssentialLoading.activar();try{const{result:s}=await this.controller.listarFiles(i,t);s.length==0&&this.notificaciones.notificarInformacion("A\xFAn no se han agregado elementos"),this.refs.listadoArchivos.value=s}catch(s){this.notificaciones.notificarError(s)}this.statusEssentialLoading.desactivar()}async listarActividades(i,t,s=!1){this.statusEssentialLoading.activar();try{const a=[];a.length==0&&this.notificaciones.notificarInformacion("A\xFAn no se han agregado elementos"),s?this.refs.listadoActividades.value.push(...a):this.refs.listadoActividades.value=a}catch{this.notificaciones.notificarError("Error al obtener el listado de actividades realizadas.")}this.statusEssentialLoading.desactivar()}async guardarArchivos(i,t){this.statusEssentialLoading.activar();try{const{response:s}=await this.controller.guardarFiles(i,t);return this.notificaciones.notificarCorrecto(s.data.mensaje),s}catch(s){if(d(s)){const a=s.erroresValidacion;await h(a,this.notificaciones)}}finally{this.statusEssentialLoading.desactivar()}}async guardarActividades(i,t){this.statusEssentialLoading.activar();try{const{response:s}=await this.controller.guardarActivities(i,t);return this.notificaciones.notificarCorrecto(s.data.mensaje),s}catch(s){if(d(s)){const a=s.erroresValidacion;await h(a,this.notificaciones)}}finally{this.statusEssentialLoading.desactivar()}}async guardarListado(i){this.statusEssentialLoading.activar();try{const{response:t}=await this.controller.guardarListado(i);return this.refs.listado.value=t.data.results,this.notificaciones.notificarCorrecto(t.data.mensaje),t}catch(t){if(d(t)){const s=t.erroresValidacion;await h(s,this.notificaciones)}}finally{this.statusEssentialLoading.desactivar()}}async editar(i,t=!0,s){if(this.statusEssentialLoading.activar(),this.entidad.id===null)return this.statusEssentialLoading.desactivar(),this.notificaciones.notificarAdvertencia("No se puede editar el recurso con id null");if(!this.seCambioEntidad(this.entidad_copia))return this.statusEssentialLoading.desactivar(),this.notificaciones.notificarAdvertencia("No se ha efectuado ningun cambio");if(this.hooks.onBeforeModificar(),this.refs.validador.value&&!await this.refs.validador.value.$validate()||!await this.ejecutarValidaciones())throw this.notificaciones.notificarAdvertencia("Verifique el formulario"),this.statusEssentialLoading.desactivar(),new Error("Verifique el formulario");this.cargarVista(async()=>{var a;try{const{response:r,result:u}=await this.controller.editar(i,{...s,...this.argsDefault});this.notificaciones.notificarCorrecto(r.data.mensaje),this.actualizarElementoListadoActual(u),this.entidad.hydrate(r.data.modelo);const n=(a=r.data.modelo.id)!=null?a:0;this.hooks.onModificado(n,r.data),t&&this.reestablecer()}catch(r){if(d(r)){const u=r.erroresValidacion;h(u,this.notificaciones)}else this.notificaciones.notificarError(r.message)}})}async editarParcial(i,t,s){return this.hooks.onBeforeModificar(),this.cargarVista(async()=>{try{const{response:a,result:r}=await this.controller.editarParcial(i,t,{...s,...this.argsDefault});this.notificaciones.notificarCorrecto(a.data.mensaje),this.actualizarElementoListadoActual(r),this.entidad.hydrate(a.data.modelo),this.reestablecer(),this.hooks.onModificado(i,a.data)}catch(a){if(d(a)){const r=a.erroresValidacion;h(r,this.notificaciones)}else this.notificaciones.notificarError(a.message);throw a}})}async eliminar(i,t){this.notificaciones.confirmar("\xBFEsta seguro que desea eliminar?",()=>{if(i.id===null)return this.notificaciones.notificarAdvertencia("No se puede eliminar el recurso con id null");this.controller.eliminar(i.id).then(({response:s})=>{this.notificaciones.notificarCorrecto(s.data.mensaje),this.eliminarElementoListaActual(i),this.reestablecer(),t&&t()}).catch(s=>{if(d(s)){const a=s.erroresValidacion;h(a,this.notificaciones)}else this.notificaciones.notificarError(s.message)})})}setValidador(i){this.refs.validador.value=i}async verificarAutenticacion(){const t=await x().isUserLoggedIn(),s=C();t||s.replace({name:"Login"})}}export{_ as C};
