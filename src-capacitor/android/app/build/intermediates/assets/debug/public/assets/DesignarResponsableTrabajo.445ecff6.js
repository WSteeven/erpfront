var ge=Object.defineProperty;var fe=(e,o,l)=>o in e?ge(e,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[o]=l;var L=(e,o,l)=>(fe(e,typeof o!="symbol"?o+"":o,l),l);import{Q as ve}from"./QBtnToggle.a42fc084.js";import{Q as F,a as N}from"./QItemSection.9a955ec6.js";import{Q as h}from"./QSelect.6ce302d7.js";import{c as $,bx as R,d as Ee,E as H,f as k,a1 as O,w as Ge,p as Se,R as $e,_ as ye,t as U,v as b,x as f,y as p,z as d,F as v,D as Q,G as I,H as z,J as V,L as Ce,a2 as je,I as we,B as qe,O as Be,P as Ve,K as M}from"./index.6449c167.js";import{c as P}from"./configuracionColumnasEmpleadoGrupo.222e165b.js";import{u as Re}from"./FiltrosListadosTarea.245f381c.js";import{S as Te}from"./Subtarea.3371ad54.js";import{a as D}from"./tareas.utils.309e0dff.js";import{a as K}from"./i18n-validators.29e2545c.js";import{u as ke}from"./index.490dde02.js";import{E as Qe}from"./EssentialSelectableTable.5a9cc771.js";import{E as Ie}from"./EssentialTable.00c17e97.js";import{u as De}from"./selector.9691ac4b.js";import{a as J,S as Ae,i as Le,n as Fe,m as Ne,q as he}from"./utils.521b98f3.js";import{E as He}from"./Empleado.20234ba0.js";import{C as Oe}from"./ContenedorSimpleMixin.09c9bed5.js";import{S as Ue}from"./SubtareaController.f99556ec.js";import{G as ze}from"./GrupoController.6ad12a37.js";function Me(e,o){const l=$(),G=$([]),c=$(),s={refListadoSeleccionable:l,listadoSeleccionable:G,endpoint:o,limpiar:()=>{c.value=null},seleccionarMultiple:r=>{e.value=[...e.value,...r]}},m=De(s);return{refListadoSeleccionable:l,listado:G,listar:()=>m.listar(c.value),limpiar:()=>s.limpiar(),seleccionar:r=>{const j=e.value.map(g=>{var C;return(C=g.id)!=null?C:-1}),w=r.filter(g=>{if(g.id)return!j.includes(g.id)});s.seleccionarMultiple(w)},criterioBusqueda:c}}class W extends He{constructor(){super();L(this,"es_responsable");this.es_responsable=!1}}const Pe=(e,o)=>{const l=$(),G=$();let c;const{accion:s}=o.value,{notificarAdvertencia:m,confirmar:y}=J();function a(u){c=u}const i={titulo:"Quitar",icono:"bi-x",color:"negative",visible:()=>[R.editar,R.nuevo].includes(s)&&!r.value,accion:({entidad:u,posicion:E})=>{y("Este empleado no participar\xE1 en la ejecuci\xF3n del trabajo. \xBFDesea continuar?",()=>{u.es_responsable&&(m("No olvides designar a otro responsable."),c("seleccionar-responsable",null)),e.value.splice(E,1)})}},r=$(!1),j={titulo:"Designar responsable",icono:"bi-arrow-left-right",color:"positive",visible:()=>!r.value&&[R.editar,R.nuevo].includes(s),accion:async()=>r.value=!0},w={titulo:"Aceptar",icono:"bi-check-circle",color:"positive",visible:()=>r.value,accion:async()=>{l.value.seleccionar(),r.value=!1}},g={titulo:"Cancelar",icono:"bi-x-circle",color:"negative",visible:()=>r.value,accion:()=>r.value=!1};async function C(u){if(u.length){const E=u[0];E.es_responsable=!0,c("seleccionar-responsable",E.id);const T=e.value.findIndex(q=>q.id===E.id);e.value=e.value.map(q=>{const B=new W;return B.hydrate(q),B.es_responsable=!1,B}),e.value.splice(T,1,E),u=[]}}return{refEmpleadosGrupo:l,empleadoGrupoQuitar:G,entidadSeleccionadaResponsable:C,quitarEmpleado:i,setEmit:a,cambiarResponsable:r,btnCambiarResponsable:j,btnConfirmarDesignarResponsable:w,btnCancelarDesignacionResponsable:g}};var Ke=Ee({components:{EssentialTable:Ie,EssentialSelectableTable:Qe},emits:["seleccionar-grupo","seleccionar-empleado","actualizar-empleados","seleccionar-modo-designacion","seleccionar-responsable"],props:{disable:Boolean,accion:String,v$:Object,subtareaInicial:{type:Object,default:null}},setup(e,{emit:o}){var A;const l=new Oe(Te,new Ue),{cargarVista:G,obtenerListados:c}=l.useComportamiento(),{entidad:s,listadosAuxiliares:m}=l.useReferencias();G(async()=>{await c({grupos:{controller:new ze,params:{campos:"id,nombre",activo:1}},empleados:{controller:new H,params:{campos:"id,nombres,apellidos,grupo_id",estado:1}}}),g.value=m.grupos,u.value=m.empleados});const y=k(()=>Z.value?"single":"none"),a=J(),i=$([]),r=new Ae,j={grupo:{required:K(()=>s.modo_asignacion_trabajo===D.por_grupo)},empleado:{required:K(()=>s.modo_asignacion_trabajo===D.por_empleado)}},w=(A=e.v$)!=null?A:ke(j,s),{grupos:g,filtrarGrupos:C,empleados:u,filtrarEmpleados:E}=Re(m,s),T=k(()=>({accion:e.accion,modo_asignacion_trabajo:s.modo_asignacion_trabajo,grupo:k(()=>s.grupo)})),{refEmpleadosGrupo:q,empleadoGrupoQuitar:B,entidadSeleccionadaResponsable:X,quitarEmpleado:Y,cambiarResponsable:Z,btnCambiarResponsable:_,btnConfirmarDesignarResponsable:x,btnCancelarDesignacionResponsable:ee,setEmit:oe}=Pe(i,T);oe(o);const{refListadoSeleccionable:ae,criterioBusqueda:se,listado:le,listar:re,limpiar:ie,seleccionar:ne}=Me(i,"empleados");O(()=>{s.modo_asignacion_trabajo=e.subtareaInicial.modo_asignacion_trabajo,s.grupo=e.subtareaInicial.grupo,s.empleado=e.subtareaInicial.empleado}),Ge(i,()=>o("actualizar-empleados",i.value)),O(()=>{i.value=e.subtareaInicial.empleados_designados});async function te(){if(s.grupo){await ce(s.grupo);const n=pe();return n&&o("seleccionar-responsable",n.id),o("seleccionar-grupo",s.grupo)}}function de(){const n=m.empleados.find(t=>t.id===s.empleado);return o("seleccionar-empleado",s.empleado,n)}function ue(){return s.empleado=null,s.grupo=null,i.value=[],o("seleccionar-modo-designacion",s.modo_asignacion_trabajo)}function pe(){return i.value.find(n=>n.es_responsable)}async function ce(n){try{r.activar();const t=new H,{result:S}=await t.listar({grupo_id:n,estado:1});i.value=me(S)}catch(t){if(Le(t)){const S=t.erroresValidacion;await Fe(S,a)}}finally{r.desactivar()}}function me(n){return n.map(t=>{const S=new W;return S.hydrate(t),S.es_responsable=typeof t.roles=="string"?Ne(t.roles.split(","),$e.tecnico_lider):!1,S})}function be(){u.value.sort((n,t)=>he(n.apellidos,t.apellidos))}return{seleccionarGrupo:te,seleccionarEmpleado:de,limpiarSelector:ue,validate$:w,subtarea:s,modosAsignacionTrabajo:D,columnasEmpleado:[...P,Se],configuracionColumnasEmpleadoGrupo:P,empleadosGrupo:i,ordenarEmpleados:be,grupos:g,filtrarGrupos:C,empleados:u,filtrarEmpleados:E,tipoSeleccion:y,refEmpleadosGrupo:q,empleadoGrupoQuitar:B,entidadSeleccionadaResponsable:X,quitarEmpleado:Y,btnCambiarResponsable:_,btnConfirmarDesignarResponsable:x,btnCancelarDesignacionResponsable:ee,refListadoSeleccionableEmpleadosGrupo:ae,criterioBusquedaEmpleadosGrupo:se,listadoEmpleadosGrupo:le,listarEmpleadosGrupo:re,limpiarEmlpeadosGrupo:ie,seleccionarEmpleadosGrupo:ne}}});const Je={class:"row q-col-gutter-xs q-pa-md q-mb-md"},We={class:"col-12 col-md-3"},Xe={key:0,class:"col-12 col-md-3"},Ye={class:"error-msg"},Ze={key:1,class:"col-12 col-md-3"},_e={class:"error-msg"},xe={key:2,class:"col-12 col-md-3"},eo={key:3,class:"col-12 row q-col-gutter-xs q-mb-md"},oo={class:"col-12 col-md-10"},ao={class:"col-12 col-md-2"},so={class:"col-12"};function lo(e,o,l,G,c,s){const m=U("essential-table"),y=U("essential-selectable-table");return b(),f(I,null,[p("div",Je,[p("div",We,[o[12]||(o[12]=p("label",{class:"q-mb-sm block"},"Trabajo designado",-1)),d(ve,{modelValue:e.subtarea.modo_asignacion_trabajo,"onUpdate:modelValue":[o[0]||(o[0]=a=>e.subtarea.modo_asignacion_trabajo=a),o[1]||(o[1]=a=>e.limpiarSelector())],class:"toggle-button",disable:e.disable,spread:"","no-caps":"",rounded:"",glossy:"","toggle-color":"positive",unelevated:"",options:[{label:"Para un grupo",value:e.modosAsignacionTrabajo.por_grupo},{label:"Para un empleado",value:e.modosAsignacionTrabajo.por_empleado}]},null,8,["modelValue","disable","options"])]),e.subtarea.modo_asignacion_trabajo===e.modosAsignacionTrabajo.por_grupo?(b(),f("div",Xe,[o[14]||(o[14]=p("label",{class:"q-mb-sm block"},"Grupo seleccionado",-1)),d(h,{modelValue:e.subtarea.grupo,"onUpdate:modelValue":[o[2]||(o[2]=a=>e.subtarea.grupo=a),o[3]||(o[3]=a=>e.seleccionarGrupo())],options:e.grupos,onFilter:e.filtrarGrupos,"transition-show":"scale","transition-hide":"scale",hint:"Obligatorio","options-dense":"",dense:"",outlined:"","option-label":a=>a.nombre,"option-value":a=>a.id,"use-input":"","input-debounce":"0","emit-value":"","map-options":"",disable:e.disable,error:!!e.validate$.grupo.$errors.length,onBlur:e.validate$.grupo.$touch},{"no-option":v(()=>[d(F,null,{default:v(()=>[d(N,{class:"text-grey"},{default:v(()=>o[13]||(o[13]=[Q(" No hay resultados ")])),_:1})]),_:1})]),error:v(()=>[(b(!0),f(I,null,z(e.validate$.grupo.$errors,a=>(b(),f("div",{key:a.$uid},[p("div",Ye,M(a.$message),1)]))),128))]),_:1},8,["modelValue","options","onFilter","option-label","option-value","disable","error","onBlur"])])):V("",!0),e.subtarea.modo_asignacion_trabajo===e.modosAsignacionTrabajo.por_empleado?(b(),f("div",Ze,[o[16]||(o[16]=p("label",{class:"q-mb-sm block"},"Empleado seleccionado",-1)),d(h,{modelValue:e.subtarea.empleado,"onUpdate:modelValue":[o[4]||(o[4]=a=>e.subtarea.empleado=a),o[6]||(o[6]=a=>e.seleccionarEmpleado())],options:e.empleados,onFilter:e.filtrarEmpleados,onPopupShow:o[5]||(o[5]=a=>e.ordenarEmpleados(e.empleados)),"transition-show":"scale","transition-hide":"scale",hint:"Obligatorio","options-dense":"",dense:"",outlined:"","option-label":a=>a.nombres+" "+a.apellidos,"option-value":a=>a.id,"use-input":"","input-debounce":"0","emit-value":"","map-options":"",disable:e.disable,error:!!e.validate$.empleado.$errors.length,onBlur:e.validate$.empleado.$touch},{"no-option":v(()=>[d(F,null,{default:v(()=>[d(N,{class:"text-grey"},{default:v(()=>o[15]||(o[15]=[Q(" No hay resultados ")])),_:1})]),_:1})]),error:v(()=>[(b(!0),f(I,null,z(e.validate$.empleado.$errors,a=>(b(),f("div",{key:a.$uid},[p("div",_e,M(a.$message),1)]))),128))]),_:1},8,["modelValue","options","onFilter","option-label","option-value","disable","error","onBlur"])])):V("",!0),e.subtarea.grupo?(b(),f("div",xe,[o[17]||(o[17]=p("br",null,null,-1)),d(Ce,{modelValue:e.subtarea.mas_empleados,"onUpdate:modelValue":o[7]||(o[7]=a=>e.subtarea.mas_empleados=a),label:"Quiero agregar m\xE1s empleados",outlined:"",disable:e.disable,dense:""},null,8,["modelValue","disable"])])):V("",!0),e.subtarea.mas_empleados?(b(),f("div",eo,[p("div",oo,[d(we,{modelValue:e.criterioBusquedaEmpleadosGrupo,"onUpdate:modelValue":o[8]||(o[8]=a=>e.criterioBusquedaEmpleadosGrupo=a),placeholder:"Nombres / Apellidos / Identificaci\xF3n",hint:"Ingrese los datos del empleado y presione Enter para buscar",onKeydown:o[9]||(o[9]=je(a=>e.listarEmpleadosGrupo(),["enter"])),onBlur:o[10]||(o[10]=a=>e.criterioBusquedaEmpleadosGrupo===""?e.limpiarTecnico():null),disable:e.disable,clearable:"",outlined:"",dense:""},null,8,["modelValue","disable"])]),p("div",ao,[d(Be,{color:"positive",class:"full-width",disable:e.disable,"no-caps":"",push:"",onClick:o[11]||(o[11]=a=>e.listarEmpleadosGrupo())},{default:v(()=>[d(qe,{name:"bi-search",size:"xs",class:"q-pr-sm"}),o[18]||(o[18]=Q("Buscar empleado "))]),_:1},8,["disable"])])])):V("",!0),p("div",so,[e.subtarea.modo_asignacion_trabajo===e.modosAsignacionTrabajo.por_grupo&&e.empleadosGrupo.length?(b(),Ve(m,{key:0,ref:"refEmpleadosGrupo",titulo:"Empleados del grupo seleccionado",estilos:"margin-bottom: 14px;",configuracionColumnas:e.columnasEmpleado,datos:e.empleadosGrupo,accion1Header:e.btnCambiarResponsable,accion2Header:e.btnConfirmarDesignarResponsable,accion3Header:e.btnCancelarDesignacionResponsable,accion1:e.quitarEmpleado,mostrarBotones:!1,permitirConsultar:!1,permitirEditar:!1,permitirEliminar:!1,"alto-fijo":!1,"mostrar-header":!0,"permitir-buscar":!1,"tipo-seleccion":e.tipoSeleccion,"mostrar-footer":!e.empleadosGrupo.length,onSelected:e.entidadSeleccionadaResponsable},null,8,["configuracionColumnas","datos","accion1Header","accion2Header","accion3Header","accion1","tipo-seleccion","mostrar-footer","onSelected"])):V("",!0)])]),d(y,{ref:"refListadoSeleccionableEmpleadosGrupo","configuracion-columnas":e.configuracionColumnasEmpleadoGrupo,datos:e.listadoEmpleadosGrupo,"tipo-seleccion":"multiple",onSelected:e.seleccionarEmpleadosGrupo},null,8,["configuracion-columnas","datos","onSelected"])],64)}var wo=ye(Ke,[["render",lo]]);export{wo as D};
